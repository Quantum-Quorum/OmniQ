name: OmniQ Build & Release

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build-ubuntu:
    name: Ubuntu Latest (CLI & Python)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y cmake g++ libgtest-dev libeigen3-dev

      - name: Configure CMake (Core)
        run: cmake -B build -DCMAKE_BUILD_TYPE=Release -DBUILD_TESTING=ON

      - name: Build Core
        run: cmake --build build --config Release

      - name: Run Tests
        run: cd build && ctest --output-on-failure

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.9'

      - name: Build Python Wheel
        run: |
          cd omniq-python
          pip install build
          python -m build

      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ubuntu-build
          path: |
            build/bin/omniq
            omniq-python/dist/*.whl

  build-macos:
    name: macOS Latest (CLI, Debugger & Python)
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Dependencies
        run: brew install eigen


      - name: Install Qt
        uses: jurplel/install-qt-action@v3
        with:
          version: '6.5.0'

      - name: Configure CMake (Core)
        run: cmake -B build_core -DCMAKE_BUILD_TYPE=Release -DBUILD_TESTING=ON

      - name: Build Core
        run: cmake --build build_core --config Release

      - name: Run Tests
        run: cd build_core && ctest --output-on-failure

      - name: Configure CMake (Debugger)
        run: |
          cd omniq-debugger
          cmake -B build_debugger -DCMAKE_BUILD_TYPE=Release -DCMAKE_PREFIX_PATH=$QT_ROOT_DIR

      - name: Build Debugger
        run: |
          cd omniq-debugger
          cmake --build build_debugger --config Release

      # Note: macdeployqt skipped in CI for simplicity unless properly set up, 
      # but we can zip the .app

      - name: Build Python Wheel
        run: |
          cd omniq-python
          pip install build
          python3 -m build

      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: macos-build
          path: |
            build_core/bin/omniq
            omniq-debugger/build_debugger/omniq-debugger.app
            omniq-python/dist/*.whl

  build-windows:
    name: Windows Latest (CLI & Python)
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4

      - name: Configure CMake (Core)
        run: cmake -B build -DCMAKE_BUILD_TYPE=Release -DBUILD_TESTING=ON

      - name: Build Core
        run: cmake --build build --config Release

      - name: Run Tests
        run: cd build && ctest --output-on-failure

      - name: Build Python Wheel
        run: |
          cd omniq-python
          pip install build
          python -m build

      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: windows-build
          path: |
            build/bin/omniq.exe
            omniq-python/dist/*.whl
